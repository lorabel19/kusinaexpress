{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KusinaExpress | Track Order</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background-color:#fffaf3; color:#2d2d2d; }

  /* HEADER */
  header { background-color:#d62828; color:white; padding:20px 40px; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
  header h1 { font-size:26px; letter-spacing:1px; }
  .menu-toggle { display:none; flex-direction:column; cursor:pointer; gap:4px; }
  .menu-toggle div { width:25px; height:3px; background:white; transition:0.3s; }
  nav { display:flex; align-items:center; gap:10px; position:relative; }
  nav a { color:white; margin:0 10px; text-decoration:none; font-weight:600; transition: color 0.3s; position:relative; }
  nav a:hover { color:#fcbf49; }
  .auth-button { margin-left:15px; padding-left:15px; border-left:2px solid rgba(255,255,255,0.3); }
  .auth-button a img { width:30px; height:30px; border-radius:50%; }
  .cart-badge { position:absolute; top:-5px; right:-17px; background:red; color:white; font-size:12px; font-weight:bold; padding:2px 6px; border-radius:50%; display:none; }

  /* MAIN CONTENT */
  main { padding: 30px 0; }
  .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
  h2.section-title { text-align:center; margin-bottom:25px; color:#d62828; font-size:28px; font-weight:700; }

  /* ORDER SUMMARY */
  .order-summary { background:white; border:2px solid #d62828; border-radius:12px; padding:20px; margin-bottom:40px; }
  .order-summary table { width:100%; border-collapse:collapse; }
  .order-summary th, .order-summary td { padding:12px 15px; text-align:left; border-bottom:1px solid #f0f0f0; vertical-align:middle; }
  .order-summary th { background:#f77f00; color:white; text-transform:uppercase; font-size:14px; letter-spacing:0.5px; }
  .order-summary td img { width:60px; height:60px; object-fit:cover; border-radius:8px; margin-right:10px; vertical-align:middle; }
  .order-summary td .item-name { vertical-align:middle; }
  .order-summary tr:last-child td { font-weight:bold; }

  /* STATUS SECTION */
  .status-section { display:flex; flex-direction:column; gap:15px; margin-bottom:40px; position:relative; }
  .status-item { 
    background:white; 
    border:2px solid #d62828; 
    border-radius:12px; 
    padding:15px 20px; 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    transition: all 0.3s;
    position:relative;
  }
  .status-item::before { content:''; position:absolute; left:-10px; top:0; bottom:0; width:4px; background:#d62828; border-radius:2px; opacity:0.2; transition: all 0.3s; }
  .status-item.active { background:#f8eded; font-weight:bold; border-color:#f77f00; }
  .status-item.active::before { opacity:1; background:#f77f00; }

  .status-item button { margin-left:10px; padding:5px 10px; border:none; background:#d62828; color:white; border-radius:6px; cursor:pointer; font-size:13px; display:none; }
  .status-item button:hover { background:#b71c1c; }

  .map-section { background:white; border:2px solid #d62828; border-radius:12px; padding:20px; }
  .map-placeholder { width:100%; height:300px; background:#f8eded; border:1px solid #f77f00; display:flex; justify-content:center; align-items:center; font-size:18px; color:#555; border-radius:10px; }

  /* FOOTER */
  footer { background-color:#3a0ca3; color:white; text-align:center; padding:25px; margin-top:50px; font-size:14px; }
  footer a { color:#fcbf49; text-decoration:none; font-weight:600; }
  footer a:hover { text-decoration:underline; }

  /* RESPONSIVE */
  @media(max-width:768px){
    .menu-toggle { display:flex; }
    nav { flex-direction:column; width:100%; display:none; }
    nav.show { display:flex; }
    nav a { width:100%; text-align:center; margin:5px 0; }
    .order-summary th, .order-summary td { font-size:13px; padding:8px; }
    .order-summary td img { width:50px; height:50px; }
  }
</style>
</head>
<body>

<header>
  <h1>KusinaExpress</h1>
  <div class="menu-toggle" id="menu-toggle">
    <div></div>
    <div></div>
    <div></div>
  </div>
  <nav id="nav-menu">
    <a href="{% url 'restaurant:dashboard' %}">Home</a>
    <a href="{% url 'restaurant:menu' %}">Menu</a>
    <a href="{% url 'restaurant:cart' %}" class="cart-button">Cart <span id="cartBadge" class="cart-badge"></span></a>
    <a href="{% url 'restaurant:order' %}">Order</a>
    <a href="{% url 'restaurant:contact' %}">Contact</a>
    <a href="{% url 'restaurant:about' %}">About Us</a>
    <div class="auth-button">
      {% if user %}
        <a href="{% url 'restaurant:profile' %}">
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Profile">
        </a>
      {% endif %}
    </div>
  </nav>
</header>

<main>
  <div class="container">

    <!-- ORDER SUMMARY -->
    <section>
      <h2 class="section-title">Your Order</h2>
      <div class="order-summary" id="orderSummary">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="orderBody">

            {% if order %}
              {% for item in order.items.all %}
              <tr>
                <td>
                  {% if item.item.image_url %}
                   <img src="{{ item.item.image_url }}" alt="{{ item.item.name }}">
                  {% else %}
                  <img src="https://via.placeholder.com/60" alt="{{ item.item.name }}">
                  {% endif %}
                  <span class="item-name">{{ item.item.name }}</span>
                </td>
                <td>{{ item.quantity }}</td>
                <td>₱{{ item.subtotal }}</td>
              </tr>
              {% endfor %}

              <!-- Shipping Fee Display Only -->
              <tr id="shippingRow">
                <td colspan="2" style="text-align:right;">Shipping Fee</td>
                <td>₱40</td>
              </tr>

              <!-- Total from BACKEND -->
              <tr id="totalRow">
                <td colspan="2" style="text-align:right; font-weight:bold;">Total</td>
                <td style="font-weight:bold;">₱{{ order.total_amount }}</td>
              </tr>

            {% else %}
              <tr id="noOrderRow">
                <td colspan="3" style="text-align:center;">No order found.</td>
              </tr>
            {% endif %}

          </tbody>
        </table>
      </div>
    </section>

    <!-- STATUS SECTION -->
    <section>
      <h2 class="section-title">Order Status</h2>
      <div class="status-section">
        <div class="status-item" data-status="Order Confirmed"><p>Order Confirmed</p><p class="time">--</p></div>
        <div class="status-item" data-status="Preparing Order"><p>Preparing Order</p><p class="time">--</p></div>
        <div class="status-item" data-status="Out for Delivery"><p>Out for Delivery</p><p class="time">--</p></div>
        <div class="status-item" data-status="Delivered">
          <p>Delivered</p>
          <p class="time">--</p>
          <button class="ack-btn">Mark as Seen</button>
        </div>
      </div>
    </section>

    <!-- MAP SECTION -->
    <section>
      <h2 class="section-title">Delivery Map</h2>
      <div class="map-section">
        <div class="map-placeholder">Map Placeholder (Delivery Route)</div>
      </div>
    </section>

  </div>
</main>

<footer>
  <p>© 2025 KusinaExpress | Proudly Serving Filipino Flavors</p>
</footer>

<script>
const toggle = document.getElementById('menu-toggle');
const nav = document.getElementById('nav-menu');
toggle.addEventListener('click', () => nav.classList.toggle('show'));

const orderId = "{{ order.order_id }}";
const statusItems = document.querySelectorAll('.status-item');
const deliveredBtn = document.querySelector('.status-item[data-status="Delivered"] .ack-btn');
const seenKey = `order_${orderId}_seen`;

function resetOrderTable(){
  const orderBody = document.getElementById('orderBody');
  orderBody.innerHTML = `<tr id="noOrderRow"><td colspan="3" style="text-align:center;">No order found.</td></tr>`;
}

if (localStorage.getItem(seenKey)) {
  statusItems.forEach(si => si.querySelector('.time').textContent = "--");
  deliveredBtn.style.display = "none";
  resetOrderTable();
}

deliveredBtn.onclick = () => {
  statusItems.forEach(si => si.querySelector('.time').textContent = "--");
  deliveredBtn.style.display = "none";
  localStorage.setItem(seenKey, "true");
  resetOrderTable();
};

async function fetchOrderStatus() {
  if (!orderId) return;
  try {
    const response = await fetch(`/api/orders/${orderId}/`);
    if (!response.ok) throw new Error("Order not found");
    const data = await response.json();
    const timestamps = data.timestamps || {};

    statusItems.forEach(item => {
      const statusName = item.dataset.status;
      const timeEl = item.querySelector('.time');

      if (timestamps[statusName] && !localStorage.getItem(seenKey)) {
        item.classList.add('active');
        timeEl.textContent = timestamps[statusName];
        if (statusName === "Delivered") deliveredBtn.style.display = "inline-block";
      } else {
        item.classList.remove('active');
        timeEl.textContent = "--";
        if (statusName === "Delivered") deliveredBtn.style.display = "none";
      }
    });

  } catch (err) { console.error("Error fetching order status:", err); }
}

if (orderId) {
  fetchOrderStatus();
  setInterval(fetchOrderStatus, 10000);
}

async function updateCartBadge() {
  try {
    const res = await fetch('/api/cart/');
    if (!res.ok) return;
    const items = await res.json();
    const count = items.reduce((acc, i) => acc + i.quantity, 0);
    const badge = document.getElementById('cartBadge');
    badge.style.display = count > 0 ? 'inline-block' : 'none';
    badge.innerText = count > 0 ? count : '';
  } catch (err) { console.error(err); }
}

updateCartBadge();
setInterval(updateCartBadge, 10000);
</script>

</body>
</html>
